---
description: Upload Android Firebase
alwaysApply: false
---

# UPLOAD ANDROID FIREBASE

## PATR√ìN DE TAG PARA ANDROID FIREBASE

```
*-a-firebase-*
```

**Ejemplos v√°lidos:**

- `3.0.0+27-a-firebase-release`
- `v3.0.0+27-a-firebase-prod`
- `release-a-firebase-1.0.0`

**Configuraci√≥n en CodeMagic:**

- ‚úÖ Marcar "Trigger on tag creation"
- ‚úÖ Agregar patr√≥n: `*-a-firebase-*` en "Watched tag patterns"
- ‚úÖ Configurar workflow de Android Firebase en CodeMagic
- ‚úÖ Asegurar que el archivo `google-services.json` est√© incluido en el build

## COMANDO R√ÅPIDO: UPLOAD ANDROID FIREBASE

### Flujo Completo Autom√°tico

**IMPORTANTE:** El agente debe preguntar al usuario si se requiere actualizar el build number en `pubspec.yaml` antes de proceder.

```bash
# 0. Verificar y agregar cambios no staged (unstaged)
if [ -n "$(git status --porcelain)" ]; then
  echo "üì¶ Agregando cambios no staged..."
  git add -A

  # Generar mensaje de commit basado en los cambios
  CHANGED_FILES=$(git diff --cached --name-only | head -5 | tr '\n' ', ' | sed 's/,$//')
  if [ -z "$CHANGED_FILES" ]; then
    COMMIT_MSG="chore: actualizar proyecto"
  else
    COMMIT_MSG="chore: actualizar proyecto - $CHANGED_FILES"
  fi

  echo "üíæ Haciendo commit de cambios..."
  git commit -m "$COMMIT_MSG"
  echo "‚úÖ Cambios commiteados"
else
  echo "‚ÑπÔ∏è  No hay cambios para commitear"
fi

# 1. Obtener versi√≥n actual del pubspec.yaml
VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //' | sed 's/+.*//')
BUILD=$(grep '^version:' pubspec.yaml | sed 's/.*+//')

# 2. PREGUNTAR: ¬øSe requiere actualizar el build number?
# El agente debe preguntar al usuario:
# "¬øDeseas actualizar el build number en pubspec.yaml? (s/n)"
# Si la respuesta es NO (n), usar la versi√≥n actual
# Si la respuesta es S√ç (s), incrementar el build number

# FLUJO SI NO SE ACTUALIZA LA VERSI√ìN (usar versi√≥n actual)
# 2a. Crear tag con versi√≥n actual
TAG="$VERSION+$BUILD-a-firebase-release"
git tag -a "$TAG" -m "Release Android Firebase $VERSION+$BUILD"

# 2b. Subir tag
BRANCH=$(git branch --show-current)
git push origin "$BRANCH"
git push origin "$TAG"

echo "‚úÖ Tag creado con versi√≥n actual: $TAG"
echo "‚úÖ Cambios subidos. CodeMagic iniciar√° el upload de Android Firebase autom√°ticamente."

# FLUJO SI S√ç SE ACTUALIZA LA VERSI√ìN (incrementar build number)
# 2a. Incrementar build number
# NEW_BUILD=$((BUILD + 1))
#
# 2b. Actualizar versi√≥n en pubspec.yaml
# sed -i '' "s/version: $VERSION+$BUILD/version: $VERSION+$NEW_BUILD/" pubspec.yaml
#
# 2c. Commit de actualizaci√≥n de versi√≥n
# git add pubspec.yaml
# git commit -m "chore: actualizar versi√≥n a $VERSION+$NEW_BUILD"
#
# 2d. Crear tag para Android Firebase
# TAG="$VERSION+$NEW_BUILD-a-firebase-release"
# git tag -a "$TAG" -m "Release Android Firebase $VERSION+$NEW_BUILD"
#
# 2e. Subir cambios y tag
# BRANCH=$(git branch --show-current)
# git push origin "$BRANCH"
# git push origin "$TAG"
#
# echo "‚úÖ Versi√≥n actualizada a $VERSION+$NEW_BUILD"
# echo "‚úÖ Tag creado: $TAG"
# echo "‚úÖ Cambios subidos. CodeMagic iniciar√° el upload de Android Firebase autom√°ticamente."
```

## PASOS MANUALES

### 0. Agregar y Commitear Cambios Pendientes

```bash
# Verificar cambios no staged
git status

# Agregar todos los cambios (staged y unstaged)
git add -A

# Hacer commit con mensaje descriptivo
git commit -m "chore: actualizar proyecto"
```

### 1. Decidir si Actualizar Versi√≥n

**El agente debe preguntar:** "¬øDeseas actualizar el build number en pubspec.yaml? (s/n)"

#### Opci√≥n A: NO actualizar versi√≥n (usar versi√≥n actual)

```bash
# Obtener versi√≥n actual
VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //' | sed 's/+.*//')
BUILD=$(grep '^version:' pubspec.yaml | sed 's/.*+//')

# Crear tag con versi√≥n actual
TAG="$VERSION+$BUILD-a-firebase-release"
git tag -a "$TAG" -m "Release Android Firebase $VERSION+$BUILD"

# Subir tag
BRANCH=$(git branch --show-current)
git push origin "$BRANCH"
git push origin "$TAG"
```

#### Opci√≥n B: S√ç actualizar versi√≥n (incrementar build number)

```bash
# Obtener versi√≥n actual
VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //' | sed 's/+.*//')
BUILD=$(grep '^version:' pubspec.yaml | sed 's/.*+//')
NEW_BUILD=$((BUILD + 1))

# Actualizar versi√≥n en pubspec.yaml
sed -i '' "s/version: $VERSION+$BUILD/version: $VERSION+$NEW_BUILD/" pubspec.yaml

# Commit de actualizaci√≥n de versi√≥n
git add pubspec.yaml
git commit -m "chore: actualizar versi√≥n a $VERSION+$NEW_BUILD"

# Crear tag para Android Firebase
TAG="$VERSION+$NEW_BUILD-a-firebase-release"
git tag -a "$TAG" -m "Release Android Firebase $VERSION+$NEW_BUILD"

# Subir cambios y tag
BRANCH=$(git branch --show-current)
git push origin "$BRANCH"
git push origin "$TAG"
```

## FORMATO DE TAG

**Formato recomendado:**

```
{version}+{build_number}-a-firebase-release
```

**Ejemplo:**

- Versi√≥n en `pubspec.yaml`: `3.0.0+27`
- Tag creado: `3.0.0+27-a-firebase-release`

## VERIFICACI√ìN

### Ver Tags de Android Firebase

```bash
git tag -l "*-a-firebase-*"
```

### Ver √öltimo Tag

```bash
git describe --tags --abbrev=0
```

### Ver Versi√≥n Actual

```bash
grep '^version:' pubspec.yaml
```

## VARIABLES DE ENTORNO EN CODEMAGIC

**Configuraci√≥n para Android Firebase:**

- `FIREBASE_PROJECT_ID` - ID del proyecto Firebase
- `FIREBASE_APP_ID` - ID de la app Android en Firebase
- `GOOGLE_SERVICES_JSON` - Contenido del archivo `google-services.json`
- Credenciales de Google Play (si aplica para distribuci√≥n)
- Variables de entorno espec√≠ficas del proyecto Android

## NOTAS IMPORTANTES

1. ‚úÖ **El agente DEBE preguntar** si se requiere actualizar el build number antes de proceder
2. ‚úÖ Si NO se actualiza la versi√≥n, se usa la versi√≥n actual del `pubspec.yaml` para crear el tag
3. ‚úÖ Si S√ç se actualiza la versi√≥n, se incrementa el build number autom√°ticamente
4. ‚úÖ El tag sigue el patr√≥n `*-a-firebase-*` para Android Firebase
5. ‚úÖ El tag se sube al remoto para activar el pipeline de Android Firebase en CodeMagic
6. ‚úÖ CodeMagic iniciar√° el upload de Android Firebase autom√°ticamente al detectar el tag
7. ‚úÖ Aseg√∫rate de tener configurado el workflow de Android Firebase en CodeMagic
8. ‚úÖ Verifica que el archivo `google-services.json` est√© actualizado en el proyecto

## TROUBLESHOOTING

### El workflow no se activa

- ‚úÖ Verificar que el tag contiene `-a-firebase-`
- ‚úÖ Verificar que "Trigger on tag creation" est√° habilitado en CodeMagic
- ‚úÖ Verificar que el tag fue subido: `git push origin {tag-name}`

### Error al crear tag

- ‚úÖ Verificar que no existe: `git tag -l "*-a-firebase-*"`
- ‚úÖ Si existe, usar un build number diferente

### Error al subir tag

- ‚úÖ Verificar permisos de push
- ‚úÖ Verificar que el tag fue creado: `git tag -l`
