---
description: Upload IOS TestFlight
alwaysApply: false
---

# UPDATE TESTFLIGHT

## PATR√ìN DE TAG PARA TESTFLIGHT

```
*-i-testflight-*
```

**Ejemplos v√°lidos:**

- `3.0.0+27-i-testflight-release`
- `v3.0.0+27-i-testflight-prod`
- `release-i-testflight-1.0.0`

**Configuraci√≥n en CodeMagic:**

- ‚úÖ Marcar "Trigger on tag creation"
- ‚úÖ Agregar patr√≥n: `*-i-testflight-*` en "Watched tag patterns"

## COMANDO R√ÅPIDO: UPDATE TESTFLIGHT

### Flujo Completo Autom√°tico

**IMPORTANTE:** El agente debe preguntar al usuario si se requiere actualizar el build number en `pubspec.yaml` antes de proceder.

```bash
# 0. Verificar y agregar cambios no staged (unstaged)
if [ -n "$(git status --porcelain)" ]; then
  echo "üì¶ Agregando cambios no staged..."
  git add -A

  # Generar mensaje de commit basado en los cambios
  CHANGED_FILES=$(git diff --cached --name-only | head -5 | tr '\n' ', ' | sed 's/,$//')
  if [ -z "$CHANGED_FILES" ]; then
    COMMIT_MSG="chore: actualizar proyecto"
  else
    COMMIT_MSG="chore: actualizar proyecto - $CHANGED_FILES"
  fi

  echo "üíæ Haciendo commit de cambios..."
  git commit -m "$COMMIT_MSG"
  echo "‚úÖ Cambios commiteados"
else
  echo "‚ÑπÔ∏è  No hay cambios para commitear"
fi

# 1. Obtener versi√≥n actual del pubspec.yaml
VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //' | sed 's/+.*//')
BUILD=$(grep '^version:' pubspec.yaml | sed 's/.*+//')

# 2. PREGUNTAR: ¬øSe requiere actualizar el build number?
# El agente debe preguntar al usuario:
# "¬øDeseas actualizar el build number en pubspec.yaml? (s/n)"
# Si la respuesta es NO (n), usar la versi√≥n actual
# Si la respuesta es S√ç (s), incrementar el build number

# FLUJO SI NO SE ACTUALIZA LA VERSI√ìN (usar versi√≥n actual)
# 2a. Crear tag con versi√≥n actual
TAG="$VERSION+$BUILD-i-testflight-release"
git tag -a "$TAG" -m "Release $VERSION+$BUILD para TestFlight"

# 2b. Subir tag
BRANCH=$(git branch --show-current)
git push origin "$BRANCH"
git push origin "$TAG"

echo "‚úÖ Tag creado con versi√≥n actual: $TAG"
echo "‚úÖ Cambios subidos. CodeMagic iniciar√° el build autom√°ticamente."

# FLUJO SI S√ç SE ACTUALIZA LA VERSI√ìN (incrementar build number)
# 2a. Incrementar build number
# NEW_BUILD=$((BUILD + 1))
#
# 2b. Actualizar versi√≥n en pubspec.yaml
# sed -i '' "s/version: $VERSION+$BUILD/version: $VERSION+$NEW_BUILD/" pubspec.yaml
#
# 2c. Commit de actualizaci√≥n de versi√≥n
# git add pubspec.yaml
# git commit -m "chore: actualizar versi√≥n a $VERSION+$NEW_BUILD"
#
# 2d. Crear tag para TestFlight
# TAG="$VERSION+$NEW_BUILD-i-testflight-release"
# git tag -a "$TAG" -m "Release $VERSION+$NEW_BUILD para TestFlight"
#
# 2e. Subir cambios y tag
# BRANCH=$(git branch --show-current)
# git push origin "$BRANCH"
# git push origin "$TAG"
#
# echo "‚úÖ Versi√≥n actualizada a $VERSION+$NEW_BUILD"
# echo "‚úÖ Tag creado: $TAG"
# echo "‚úÖ Cambios subidos. CodeMagic iniciar√° el build autom√°ticamente."
```

## PASOS MANUALES

### 0. Agregar y Commitear Cambios Pendientes

```bash
# Verificar cambios no staged
git status

# Agregar todos los cambios (staged y unstaged)
git add -A

# Hacer commit con mensaje descriptivo
git commit -m "chore: actualizar proyecto"
```

### 1. Decidir si Actualizar Versi√≥n

**El agente debe preguntar:** "¬øDeseas actualizar el build number en pubspec.yaml? (s/n)"

#### Opci√≥n A: NO actualizar versi√≥n (usar versi√≥n actual)

```bash
# Obtener versi√≥n actual
VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //' | sed 's/+.*//')
BUILD=$(grep '^version:' pubspec.yaml | sed 's/.*+//')

# Crear tag con versi√≥n actual
TAG="$VERSION+$BUILD-i-testflight-release"
git tag -a "$TAG" -m "Release $VERSION+$BUILD para TestFlight"

# Subir tag
BRANCH=$(git branch --show-current)
git push origin "$BRANCH"
git push origin "$TAG"
```

#### Opci√≥n B: S√ç actualizar versi√≥n (incrementar build number)

```bash
# Obtener versi√≥n actual
VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //' | sed 's/+.*//')
BUILD=$(grep '^version:' pubspec.yaml | sed 's/.*+//')
NEW_BUILD=$((BUILD + 1))

# Actualizar versi√≥n en pubspec.yaml
sed -i '' "s/version: $VERSION+$BUILD/version: $VERSION+$NEW_BUILD/" pubspec.yaml

# Commit de actualizaci√≥n de versi√≥n
git add pubspec.yaml
git commit -m "chore: actualizar versi√≥n a $VERSION+$NEW_BUILD"

# Crear tag para TestFlight
TAG="$VERSION+$NEW_BUILD-i-testflight-release"
git tag -a "$TAG" -m "Release $VERSION+$NEW_BUILD para TestFlight"

# Subir cambios y tag
BRANCH=$(git branch --show-current)
git push origin "$BRANCH"
git push origin "$TAG"
```

## FORMATO DE TAG

**Formato recomendado:**

```
{version}+{build_number}-i-testflight-release
```

**Ejemplo:**

- Versi√≥n en `pubspec.yaml`: `3.0.0+27`
- Tag creado: `3.0.0+27-i-testflight-release`

## VERIFICACI√ìN

### Ver Tags de TestFlight

```bash
git tag -l "*testflight*"
```

### Ver √öltimo Tag

```bash
git describe --tags --abbrev=0
```

### Ver Versi√≥n Actual

```bash
grep '^version:' pubspec.yaml
```

## VARIABLES DE ENTORNO EN CODEMAGIC

**Grupo requerido: `app_store_connect_credentials`**

- `APP_STORE_CONNECT_ISSUER_ID`
- `APP_STORE_CONNECT_KEY_IDENTIFIER`
- `APP_STORE_CONNECT_PRIVATE_KEY` (contenido del archivo .p8)

## NOTAS IMPORTANTES

1. ‚úÖ **El agente DEBE preguntar** si se requiere actualizar el build number antes de proceder
2. ‚úÖ Si NO se actualiza la versi√≥n, se usa la versi√≥n actual del `pubspec.yaml` para crear el tag
3. ‚úÖ Si S√ç se actualiza la versi√≥n, se incrementa el build number autom√°ticamente
4. ‚úÖ El tag sigue el patr√≥n `*-i-testflight-*`
5. ‚úÖ El tag se sube al remoto para activar CodeMagic
6. ‚úÖ CodeMagic iniciar√° el build autom√°ticamente al detectar el tag

## TROUBLESHOOTING

### El workflow no se activa

- ‚úÖ Verificar que el tag contiene `-i-testflight-`
- ‚úÖ Verificar que "Trigger on tag creation" est√° habilitado en CodeMagic
- ‚úÖ Verificar que el tag fue subido: `git push origin {tag-name}`

### Error al crear tag

- ‚úÖ Verificar que no existe: `git tag -l "*testflight*"`
- ‚úÖ Si existe, usar un build number diferente

### Error al subir tag

- ‚úÖ Verificar permisos de push
- ‚úÖ Verificar que el tag fue creado: `git tag -l`
